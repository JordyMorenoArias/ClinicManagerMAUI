@page "/Pacientes"
@using ClinicManagerMAUI.Models.DTOs.Allergy
@using ClinicManagerMAUI.Models.DTOs.PatientAllergy

@inject IAuthService _authService
@inject IPatientService _patientService
@inject IMedicalRecordService _medicalRecordService
@inject ISecureStorageService _secureStorageService
@inject IAllergyService _allergyService
@inject IPatientAllergyService _patientAllergyService

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-0">Gestión de Citas</h2>
        </div>
    </div>

    <!-- Barra de acciones -->
    <div class="row mb-3">
        <div class="col-md-6">
            <button class="btn btn-primary" @onclick="ShowAddModal">
                <i class="bi bi-plus-circle"></i> Añadir Paciente
            </button>
        </div>
    </div>

    <!-- Tabla de datos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Cédula</th>
                                    <th>Nombre</th>
                                    <th>Celular</th>
                                    <th>Email</th>
                                    <th>Fecha de nacimiento</th>
                                    <th>Alergias</th>
                                    <th class="text-end">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (patientPagedResult.Items != null && patientPagedResult.Items.Any())
                                {
                                    @foreach (var item in patientPagedResult.Items)
                                    {
                                        <tr>
                                            <td>@item.Id</td>
                                            <td>@item.Identification</td>
                                            <td>@item.FullName</td>
                                            <td>@item.Phone</td>
                                            <td>@item.Email</td>
                                            <td>@item.DateOfBirth.ToString("dd/MM/yyyy")</td>
                                            <td>
                                                @if (item.Allergies != null && item.Allergies.Any())
                                                {
                                                    <div class="d-flex flex-wrap gap-1">
                                                        @foreach (var allergy in item.Allergies)
                                                        {
                                                            var badgeClass = GetSeverityBadgeClass(allergy.Severity);
                                                            <span class="badge @badgeClass"
                                                                  title="@allergy.Allergy?.Name - Severidad: @allergy.Severity (@allergy.Notes)">
                                                                @allergy.Allergy?.Name
                                                                @if (allergy.Severity == SeverityAllergy.Severe)
                                                                {
                                                                    <i class="bi bi-exclamation-triangle-fill ms-1"></i>
                                                                }
                                                            </span>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted small">Sin alergias</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-outline-primary"
                                                            @onclick="() => ShowEditModal(item)"
                                                            title="Editar paciente">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-success"
                                                            @onclick="() => ShowAddPatientAllergy(item)"
                                                            title="Gestionar alergias">
                                                        <i class="bi bi-heart-pulse"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary"
                                                            @onclick="() => OpenModalRecord(item)"
                                                            title="Ver registros médicos">
                                                        <i class="bi bi-folder2-open"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center py-4 text-muted">
                                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                            No hay datos para mostrar
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    @if (patientPagedResult != null && patientPagedResult.TotalPages > 1)
                    {
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted small">
                                Mostrando @GetStartRecord() - @GetEndRecord() de @patientPagedResult.TotalItems registros
                            </div>

                            <nav aria-label="Paginación">
                                <ul class="pagination mb-0">
                                    <li class="page-item @(patientPagedResult.Page == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="FirstPage">Primero</button>
                                    </li>
                                    <li class="page-item @(patientPagedResult.Page == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="PreviousPage">Anterior</button>
                                    </li>

                                    @for (int i = GetStartPage(); i <= GetEndPage(); i++)
                                    {
                                        var pageNumber = i;
                                        <li class="page-item @(patientPagedResult.Page == pageNumber ? "active" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(pageNumber)">
                                                @pageNumber
                                            </button>
                                        </li>
                                    }

                                    <li class="page-item @(patientPagedResult.Page == patientPagedResult.TotalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="NextPage">Siguiente</button>
                                    </li>
                                    <li class="page-item @(patientPagedResult.Page == patientPagedResult.TotalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="LastPage">Último</button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Añadir/Editar Paciente -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditMode ? "Editar Paciente" : "Nuevo Paciente")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" @bind="currentItem.FullName" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cédula</label>
                        <input type="text"
                               class="form-control"
                               @bind="currentItem.Identification"
                               maxlength="11"
                               oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control" @bind="currentItem.Phone" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" @bind="currentItem.Email" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" @bind="currentItem.Address" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fecha de Nacimiento</label>
                        <input type="date" class="form-control" @bind="currentItem.DateOfBirth" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancelar</button>
                    @if (isEditMode)
                    {
                        <button type="button" class="btn btn-primary" @onclick="UpdatePatient">Actualizar</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-primary" @onclick="AddPatient">Guardar</button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (showRecordsModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registros médicos de @currentItem.FullName</h5>
                    <button type="button" class="btn-close" @onclick="CloseRecordsModal"></button>
                </div>

                <div class="modal-body">

                    <!-- Botón de añadir registro (solo Admin o Doctor) -->
                    @if (userRole == UserRole.admin || userRole == UserRole.doctor)
                    {
                        <div class="mb-3 text-end">
                            <button class="btn btn-primary btn-sm" @onclick="ShowAddRecordModal">
                                <i class="bi bi-plus-circle"></i> Añadir registro
                            </button>
                        </div>
                    }

                    <!-- Lista de registros médicos -->
                    @if (medicalRecordPagedResult.Items != null && medicalRecordPagedResult.Items.Any())
                    {
                        <div class="list-group">
                            @foreach (var record in medicalRecordPagedResult.Items)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="fw-semibold text-primary">
                                                Diagnóstico: @record.Diagnosis
                                            </div>
                                            <div class="text-muted">
                                                Tratamiento: @(string.IsNullOrWhiteSpace(record.Treatment) ? "N/A" : record.Treatment)
                                            </div>
                                            <small class="text-secondary">
                                                Doctor: @record.Doctor.FullName • Fecha: @record.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                            </small>
                                        </div>

                                        <!-- Botón de editar solo si el doctor actual es quien creó el registro -->
                                        @if (userRole == UserRole.doctor && currentDoctorId == record.DoctorId)
                                        {
                                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => ShowEditRecordModal(record)">
                                                <i class="bi bi-pencil"></i> Editar
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            No se encontraron registros médicos.
                        </div>
                    }

                    <!-- Controles de paginación -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button class="btn btn-outline-secondary btn-sm" @onclick="PrevModalRecordPage">Anterior</button>
                        <span class="fw-semibold text-secondary">
                            Página @medicalRecordQueryParameters.Page
                        </span>
                        <button class="btn btn-outline-secondary btn-sm" @onclick="NextModalRecordPage">Siguiente</button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseRecordsModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showRecordModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((isEditRecordMode ? "Editar" : "Añadir") + " Registro Médico")</h5>
                    <button type="button" class="btn-close" @onclick="CloseRecordModal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Diagnóstico <span class="text-danger">*</span></label>
                        <textarea class="form-control" @bind="currentRecord.Diagnosis" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tratamiento</label>
                        <textarea class="form-control" @bind="currentRecord.Treatment" rows="3"></textarea>
                    </div>

                    @if (isEditRecordMode)
                    {
                        <div class="mb-3">
                            <label class="form-label">Doctor</label>
                            <input type="text" class="form-control" value="@currentRecord.Doctor.FullName" readonly />
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseRecordModal">Cancelar</button>
                    @if (isEditRecordMode)
                    {
                        <button class="btn btn-primary" @onclick="UpdateMedicalRecord">Actualizar</button>
                    }
                    else
                    {
                        <button class="btn btn-primary" @onclick="AddMedicalRecord">Guardar</button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (showAddPatientAllergyModal)
{
    <div class="modal fade show d-block" tabindex="-1"
         style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Añadir Alergia al Paciente</h5>
                    <button class="btn-close" @onclick="() => showAddPatientAllergyModal = false"></button>
                </div>

                <div class="modal-body">

                    <!-- PACIENTE -->
                    <div class="mb-3">
                        <label class="form-label">Paciente</label>

                        <div class="input-group">
                            <span class="input-group-text">ID</span>
                            <input type="text" class="form-control"
                                   value="@newPatientAllergy.PatientId" readonly />

                            <span class="input-group-text">Nombre</span>
                            <input type="text" class="form-control"
                                   value="@patientPagedResult?.Items?.FirstOrDefault(x => x.Id == newPatientAllergy.PatientId)?.FullName"
                                   readonly />

                            <!-- Botón invisible solo para mantener el ancho -->
                            <button class="btn btn-outline-primary invisible" disabled>
                                Seleccionar
                            </button>
                        </div>
                    </div>

                    <!-- ALERGIA -->
                    <div class="mb-3">
                        <label class="form-label">Alergia</label>

                        <div class="input-group">
                            <span class="input-group-text">ID</span>
                            <input type="text" class="form-control"
                                   value="@newPatientAllergy.AllergyId" readonly />

                            <span class="input-group-text">Nombre</span>
                            <input type="text" class="form-control"
                                   value="@allergyPagedResult.Items.FirstOrDefault(x => x.Id == newPatientAllergy.AllergyId)?.Name"
                                   readonly />

                            <button class="btn btn-outline-primary"
                                    type="button"
                                    @onclick="OpenSelectorAllergy">
                                Seleccionar
                            </button>
                        </div>
                    </div>

                    <!-- SEVERITY -->
                    <div class="mb-3">
                        <label class="form-label">Severidad</label>
                        <select class="form-select" @bind="newPatientAllergy.Severity">
                            <option value="@SeverityAllergy.Mild">Leve</option>
                            <option value="@SeverityAllergy.Moderate">Moderada</option>
                            <option value="@SeverityAllergy.Severe">Severa</option>
                        </select>
                    </div>

                    <!-- NOTES -->
                    <div class="mb-3">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" rows="3"
                                  @bind="newPatientAllergy.Notes"></textarea>
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary"
                            @onclick="() => showAddPatientAllergyModal = false">
                        Cancelar
                    </button>

                    <button class="btn btn-primary"
                            @onclick="CreatePatientAllergy">
                        Guardar
                    </button>
                </div>

            </div>
        </div>
    </div>
}

@if (showAllergySelector)
{
    <div class="modal fade show d-block" tabindex="-1"
         style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Seleccionar Alergia</h5>
                    <button class="btn-close" @onclick="CloseAllergySelector"></button>
                </div>

                <button class="btn btn-outline-success ms-2" @onclick="ShowAddAllergyModal">
                    <i class="bi bi-plus-circle"></i> Añadir Alergia
                </button>

                <div class="modal-body">

                    <!-- BUSCADOR -->
                    <div class="input-group mb-3">
                        <input type="text" class="form-control"
                               placeholder="Buscar alergia..."
                               @bind="allergyQueryParameters.SearchTerm" />

                        <button class="btn btn-outline-primary"
                                @onclick="FilterAllergies">
                            Buscar
                        </button>
                    </div>

                    <!-- LISTA -->
                    @if (allergyPagedResult.Items != null && allergyPagedResult.Items.Any())
                    {
                        <div class="list-group">
                            @foreach (var a in allergyPagedResult.Items)
                            {
                                <button class="list-group-item list-group-item-action"
                                        @onclick="() => SelectAllergy(a)">
                                    <div class="fw-semibold">@a.Name</div>
                                    <small class="text-muted">ID: @a.Id</small>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            No se encontraron alergias.
                        </div>
                    }

                    <!-- PAGINACIÓN -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <button class="btn btn-outline-secondary btn-sm"
                                @onclick="PrevAllergyPage">
                            Anterior
                        </button>

                        <span class="fw-semibold text-secondary">
                            Página @allergyQueryParameters.Page
                        </span>

                        <button class="btn btn-outline-secondary btn-sm"
                                @onclick="NextAllergyPage">
                            Siguiente
                        </button>
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseAllergySelector">
                        Cerrar
                    </button>
                </div>

            </div>
        </div>
    </div>
}

@if (showAddAllergyModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Nueva Alergia</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddAllergyModal"></button>
                </div>

                <div class="modal-body">

                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" @bind="newAllergy.Name">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" rows="3" @bind="newAllergy.Description"></textarea>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddAllergyModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateAllergy">Guardar</button>
                </div>

            </div>
        </div>
    </div>
}


@code {
    // ============================
    //      PATIENTS
    // ============================
    private PagedResult<PatientDto> patientPagedResult = new();
    private QueryPatientParameters patientQueryParameters = new()
    {
        Page = 1,
        PageSize = 6,
        SearchTerm = string.Empty,
        DateOfBirth = null
    };

    private PatientDto currentItem = new();

    // ============================
    //      MEDICAL RECORDS
    // ============================
    private PagedResult<MedicalRecordDto> medicalRecordPagedResult = new();
    private QueryMedicalRecordParameters medicalRecordQueryParameters = new()
    {
        Page = 1,
        PageSize = 6
    };

    // ============================
    //      MODAL CONTROL
    // ============================
    private bool showModal = false;
    private bool isEditMode;

    // ============================
    //      MODAL RECORS CONTROL
    // ============================
    private bool showRecordsModal = false;
    private UserRole userRole;
    private int currentDoctorId;

    // ============================
    //      MODAL RECORD CONTROL
    // ============================
    private bool showRecordModal = false;
    private bool isEditRecordMode = false;
    private MedicalRecordDto currentRecord = new();

    // ============================
    //      ADD PATIENT ALLERGY
    // ============================
    private bool showAddPatientAllergyModal = false;
    private AddPatientAllergyDto newPatientAllergy = new();

    // ============================
    //      ADD ALLERGY
    // ============================
    private bool showAllergySelector = false;
    private bool showAddAllergyModal = false;

    private AllergyDto newAllergy = new();
    private PagedResult<AllergyDto> allergyPagedResult = new();
    private QueryAllergyParameters allergyQueryParameters = new()
    {
        Page = 1,
        PageSize = 10,
        SearchTerm = string.Empty
    };

    private void ShowAddPatientAllergy(PatientDto patient)
    {
        newPatientAllergy = new AddPatientAllergyDto
        {
            PatientId = patient.Id,
            Severity = SeverityAllergy.Mild,
            Notes = ""
        };

        showAddPatientAllergyModal = true;
    }

    private async Task CreatePatientAllergy()
    {
        var response = await _patientAllergyService.CreatePatientAllergy(newPatientAllergy);

        if (response.Success)
        {
            showAddPatientAllergyModal = false;
            await LoadPatients();
        }
    }

    // ============================
    //      INITIAL LOAD
    // ============================
    protected override async Task OnInitializedAsync()
    {
        await LoadPatients();
    }

    private async Task LoadPatients()
    {
        var response = await _patientService.GetPatients(patientQueryParameters);

        if (response.Success)
            patientPagedResult = response.Data!;
    }

    private async Task AddPatient()
    {
        var dto = new AddPatientDto
        {
            FullName = currentItem.FullName,
            Identification = currentItem.Identification,
            Phone = currentItem.Phone,
            Email = currentItem.Email,
            Address = currentItem.Address,
            DateOfBirth = currentItem.DateOfBirth
        };

        var response = await _patientService.CreatePatient(dto);
        if (response.Success)
        {
            await LoadPatients();
            CloseModal();
        }
    }

    private async Task UpdatePatient()
    {
        var dto = new UpdatePatientDto
        {
            Id = currentItem.Id,
            FullName = currentItem.FullName,
            Identification = currentItem.Identification,
            Phone = currentItem.Phone,
            Email = currentItem.Email,
            Address = currentItem.Address,
            DateOfBirth = currentItem.DateOfBirth
        };

        var response = await _patientService.UpdatePatient(dto);
        if (response.Success)
        {
            await LoadPatients();
            CloseModal();
        }
    }

    // ============================
    //      MODAL HANDLERS
    // ============================
    private void ShowAddModal()
    {
        currentItem = new();
        showModal = true;
    }

    private void ShowEditModal(PatientDto item)
    {
        isEditMode = true;
        currentItem = new PatientDto
        {
            Id = item.Id,
            FullName = item.FullName,
            Identification = item.Identification,
            Phone = item.Phone,
            Email = item.Email,
            Address = item.Address,
            DateOfBirth = item.DateOfBirth
        };
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        currentItem = new();
    }

    // ============================
    //      PAGINATION
    // ============================
    private async Task FirstPage()
    {
        if (patientPagedResult.Page == 1) return;

        patientQueryParameters.Page = 1;
        await LoadPatients();
    }

    private async Task PreviousPage()
    {
        if (patientPagedResult.Page > 1)
        {
            patientQueryParameters.Page--;
            await LoadPatients();
        }
    }

    private async Task NextPage()
    {
        if (patientPagedResult.Page < patientPagedResult.TotalPages)
        {
            patientQueryParameters.Page++;
            await LoadPatients();
        }
    }

    private async Task LastPage()
    {
        if (patientPagedResult.Page == patientPagedResult.TotalPages) return;

        patientQueryParameters.Page = patientPagedResult.TotalPages;
        await LoadPatients();
    }

    private async Task GoToPage(int pageNumber)
    {
        if (pageNumber < 1 || pageNumber > patientPagedResult.TotalPages) return;

        patientQueryParameters.Page = pageNumber;
        await LoadPatients();
    }

    // ============================
    //      AUXILIARY CALCULATIONS
    // ============================
    private int GetStartRecord()
    {
        if (patientPagedResult.TotalItems == 0) return 0;
        return ((patientPagedResult.Page - 1) * patientPagedResult.PageSize) + 1;
    }

    private int GetEndRecord()
    {
        if (patientPagedResult.TotalItems == 0) return 0;
        return Math.Min(patientPagedResult.Page * patientPagedResult.PageSize, patientPagedResult.TotalItems);
    }

    private int GetStartPage()
    {
        int start = Math.Max(1, patientPagedResult.Page - 2);
        return Math.Min(start, Math.Max(1, patientPagedResult.TotalPages - 4));
    }

    private int GetEndPage()
    {
        int end = Math.Min(patientPagedResult.TotalPages, GetStartPage() + 4);
        return Math.Max(end, Math.Min(5, patientPagedResult.TotalPages));
    }

    // ============================
    //      MODAL RECORDS HANDLERS
    // ============================

    private async Task LoadMedicalRecords()
    {
        var response = await _medicalRecordService.GetMedicalRecords(medicalRecordQueryParameters);

        if (response.Success)
            medicalRecordPagedResult = response.Data!;
    }

    private async Task FilterPatients()
    {
        patientQueryParameters.Page = 1;
        await LoadPatients();
    }

    private async Task PrevModalRecordPage()
    {
        if (medicalRecordQueryParameters.Page > 1)
        {
            medicalRecordQueryParameters.Page--;
            await LoadMedicalRecords();
        }
    }

    private async Task NextModalRecordPage()
    {
        if (medicalRecordQueryParameters.Page >= medicalRecordPagedResult.TotalPages)
            medicalRecordQueryParameters.Page = 1;
        else
            medicalRecordQueryParameters.Page++;

        await LoadMedicalRecords();
    }

    private async Task OpenModalRecord(PatientDto patient)
    {
        currentItem = patient;
        medicalRecordQueryParameters.patientId = patient.Id;
        var userAuthenticated = await _authService.DecodeAsync();
        currentDoctorId = userAuthenticated.Id;
        userRole = userAuthenticated.Role;
        await LoadMedicalRecords();
        showRecordsModal = true;
    }

    private void CloseRecordsModal()
    {
        showRecordsModal = false;
        currentItem = new();
        medicalRecordPagedResult = new();
    }

    // ============================
    //      MODAL RECORD HANDLERS
    // ============================
    private void ShowAddRecordModal()
    {
        isEditRecordMode = false;
        currentRecord = new MedicalRecordDto
        {
            PatientId = currentItem.Id,
            DoctorId = currentDoctorId
        };
        showRecordModal = true;
    }

    private void ShowEditRecordModal(MedicalRecordDto record)
    {
        isEditRecordMode = true;
        currentRecord = record;
        showRecordModal = true;
    }

    private void CloseRecordModal()
    {
        showRecordModal = false;
        currentRecord = new MedicalRecordDto();
    }

    // Badge visual para severidad
    private string GetSeverityBadge(SeverityAllergy severity) => severity switch
    {
        SeverityAllergy.Mild => "bg-success",
        SeverityAllergy.Moderate => "bg-warning text-dark",
        SeverityAllergy.Severe => "bg-danger",
        _ => "bg-secondary"
    };

    // ============================
    //      MÉTODOS DE GUARDADO
    // ============================
    private async Task AddMedicalRecord()
    {
        var dto = new AddMedicalRecordDto
        {
            PatientId = currentRecord.PatientId,
            Diagnosis = currentRecord.Diagnosis,
            Treatment = currentRecord.Treatment
        };

        var response = await _medicalRecordService.CreateMedicalRecord(dto);

        if (response.Success)
        {
            await LoadMedicalRecords();
            CloseRecordModal();
        }
    }

    private async Task UpdateMedicalRecord()
    {
        var dto = new UpdateMedicalRecordDto
        {
            Id = currentRecord.Id,
            Diagnosis = currentRecord.Diagnosis,
            Treatment = currentRecord.Treatment
        };

        var response = await _medicalRecordService.UpdateMedicalRecord(dto);

        if (response.Success)
        {
            await LoadMedicalRecords();
            CloseRecordModal();
        }
    }

    // Método para obtener la clase CSS según la severidad
    private string GetSeverityBadgeClass(SeverityAllergy severity)
    {
        return severity switch
        {
            SeverityAllergy.Mild => "bg-success-subtle text-success",
            SeverityAllergy.Moderate => "bg-warning-subtle text-warning",
            SeverityAllergy.Severe => "bg-danger text-white",
            _ => "bg-secondary"
        };
    }

    // ============================
    //  HANDLING ALLERGY SELECTION
    // ============================
    private async Task LoadAllergies()
    {
        var response = await _allergyService.GetAllergies(allergyQueryParameters);
        if (response.Success)
            allergyPagedResult = response.Data!;
    }

    private async Task FilterAllergies()
    {
        allergyQueryParameters.Page = 1;
        await LoadAllergies();
    }

    private async Task OpenSelectorAllergy()
    {
        await LoadAllergies();
        showAllergySelector = true;
    }

    private void CloseAllergySelector()
    {
        showAllergySelector = false;
    }

    private void SelectAllergy(AllergyDto allergy)
    {
        newPatientAllergy.AllergyId = allergy.Id;
        showAllergySelector = false;
    }

    private async Task PrevAllergyPage()
    {
        if (allergyQueryParameters.Page > 1)
        {
            allergyQueryParameters.Page--;
            await LoadAllergies();
        }
    }

    private async Task NextAllergyPage()
    {
        allergyQueryParameters.Page++;
        await LoadAllergies();
    }

    // ============================
    //      ADD ALLERGY HANDLERS
    // ============================
    private void ShowAddAllergyModal()
    {
        newAllergy = new AllergyDto();
        showAddAllergyModal = true;
    }

    private void CloseAddAllergyModal()
    {
        showAddAllergyModal = false;
    }

    private async Task CreateAllergy()
    {
        var dto = new CreateAllergyDto
        {
            Name = newAllergy.Name,
            Description = newAllergy.Description
        };

        var response = await _allergyService.CreateAllergy(dto);

        if (response.Success)
        {
            await LoadAllergies();     // recargar lista en el selector
            showAddAllergyModal = false;
        }
    }

}

<style>
    /* Estilos personalizados para las alergias */
    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
        font-weight: 500;
    }

    .table td {
        vertical-align: middle;
    }

    .gap-1 {
        gap: 0.25rem;
    }

    /* Tooltip personalizado para alergias */
    [title] {
        cursor: help;
    }

    /* Botones de acción más compactos */
    .btn-group-sm > .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>